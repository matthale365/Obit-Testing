<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Rotator and Viewer</title>
    <style>
        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3d3d3d;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --border-color: #495057;
            --shadow: rgba(0,0,0,0.4);
            --accent: #32a852;
            --accent-hover: #3bc95f;
            --accent-light: #1a3d24;
            --card-bg: #2d2d2d;
            --crop-accent: #ffc107;
            --crop-accent-hover: #ffca2c;
        }

        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family: Arial, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* ‚îÄ‚îÄ‚îÄ pages ‚îÄ‚îÄ‚îÄ */
        .page { display:none; min-height:100vh; padding:20px; }
        .page.active { display:block !important; }

        /* ‚îÄ‚îÄ‚îÄ page 1 ‚Äì upload ‚îÄ‚îÄ‚îÄ */
        #upload-page { flex-direction:column; align-items:center; justify-content:center; }
        #upload-page.active { display:flex !important; }

        .upload-container {
            background: var(--card-bg);
            padding: 50px;
            border-radius: 10px;
            box-shadow: 0 4px 6px var(--shadow);
            text-align: center;
            max-width: 600px;
            width: 90%;
            border: 1px solid var(--border-color);
        }
        .upload-container h1 { margin-bottom:30px; color:var(--text-primary); }
        .upload-container > p { color:var(--text-secondary); margin-bottom:20px; }

        .file-input-wrapper { position:relative; margin:30px 0; }
        .file-input-wrapper input[type="file"] { position:absolute; opacity:0; width:100%; height:100%; cursor:pointer; }

        .file-input-label {
            display:block; padding:40px;
            border: 3px dashed var(--accent);
            border-radius:10px;
            background: var(--accent-light);
            cursor:pointer; transition:all .3s;
        }
        .file-input-label:hover { background:var(--accent); border-color:var(--accent-hover); }
        .file-input-label > div:first-child { font-size:48px; margin-bottom:10px; }
        .file-input-label > div:last-child { color:var(--accent); font-weight:600; }
        .file-input-label:hover > div:last-child { color:#fff; }

        .file-count { margin:20px 0; color:var(--text-secondary); font-size:18px; }

        /* ‚îÄ‚îÄ‚îÄ buttons ‚îÄ‚îÄ‚îÄ */
        .btn {
            padding:15px 40px; font-size:18px; border:none; border-radius:5px;
            cursor:pointer; transition:all .3s; margin:10px;
            background:var(--accent); color:#fff; font-weight:600;
        }
        .btn:hover { background:var(--accent-hover); transform:translateY(-2px); box-shadow:0 4px 12px var(--shadow); }
        .btn-primary { background:var(--accent); color:#fff; }
        .btn-primary:hover { background:var(--accent-hover); }
        .btn-primary:disabled { background:#6c757d; cursor:not-allowed; opacity:.5; }
        .btn-primary:disabled:hover { transform:none; box-shadow:none; }
        .btn-small { padding:15px 30px; font-size:16px; font-weight:600; }
        .btn-secondary { background:#6c757d; color:#fff; }
        .btn-secondary:hover { background:#545b62; }

        /* ‚îÄ‚îÄ‚îÄ page 2 ‚Äì grid ‚îÄ‚îÄ‚îÄ */
        #grid-page { background:var(--bg-secondary); }

        .grid-header {
            background:var(--card-bg); padding:20px; margin-bottom:20px;
            border-radius:8px; box-shadow:0 2px 8px var(--shadow);
            display:flex; justify-content:space-between; align-items:center;
            gap:20px; border:1px solid var(--border-color);
        }
        .grid-header h2 { color:#fff; margin:0 0 5px; }
        .grid-header p  { color:#ccc; margin:0; }

        .upload-more-container { display:flex; align-items:center; gap:10px; }
        .upload-more-unified {
            padding:35px 50px; border:3px dashed var(--accent); border-radius:8px;
            background:var(--accent-light); cursor:pointer; transition:all .3s;
            text-align:center; min-width:250px;
        }
        .upload-more-title { color:var(--accent); font-size:22px; font-weight:700; margin-bottom:8px; }
        .upload-more-subtitle { color:var(--accent); font-size:14px; opacity:.8; }
        .upload-more-unified:hover { background:var(--accent); border-color:var(--accent-hover); transform:translateY(-2px); box-shadow:0 4px 12px var(--shadow); }
        .upload-more-unified:hover .upload-more-title,
        .upload-more-unified:hover .upload-more-subtitle { color:#fff; opacity:1; }
        .upload-more-unified.drag-over { background:var(--accent); border-color:var(--accent-hover); transform:scale(1.05); }
        .upload-more-unified.drag-over .upload-more-title,
        .upload-more-unified.drag-over .upload-more-subtitle { color:#fff; opacity:1; }

        .image-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:20px; max-width:1400px; margin:0 auto; }
        .grid-item {
            background:var(--card-bg); border-radius:8px; overflow:hidden;
            box-shadow:0 2px 8px var(--shadow); cursor:pointer;
            transition:transform .2s, box-shadow .2s;
            border:1px solid var(--border-color); position:relative;
        }
        .grid-item:hover { transform:translateY(-5px); box-shadow:0 6px 16px var(--shadow); }
        .grid-item-image { width:100%; height:250px; object-fit:cover; display:block; }
        .grid-item-name { text-align:left; font-size:14px; color:#fff; word-break:break-word; flex:1; }
        .grid-item-name-container {
            display:flex; align-items:center; justify-content:space-between;
            gap:12px; width:100%; padding:15px; background:var(--bg-tertiary);
        }

        .loading { text-align:center; padding:40px; font-size:18px; color:#fff; }

        .delete-btn {
            background:#dc3545; color:#fff; border:none; border-radius:4px;
            width:28px; height:28px; cursor:pointer; display:flex;
            align-items:center; justify-content:center; flex-shrink:0;
            transition:background .2s; padding:0;
        }
        .delete-btn svg { width:16px; height:16px; fill:#fff; display:block; margin:auto; }
        .delete-btn:hover { background:#c82333; }

        .done-section {
            margin-top:40px; padding:20px; background:var(--card-bg);
            border-radius:8px; border:2px dashed var(--accent); box-shadow:0 2px 8px var(--shadow);
        }
        .done-section h3 { margin-top:0; color:var(--accent); }
        .done-list { display:flex; flex-direction:column; gap:8px; }
        .done-item {
            background:var(--accent-light); padding:8px 12px; border-radius:4px;
            border:1px solid var(--accent); color:var(--accent); font-size:14px; font-weight:600;
        }

        /* ‚îÄ‚îÄ‚îÄ page 3 ‚Äì viewer ‚îÄ‚îÄ‚îÄ */
        #viewer-page {
            position:fixed; top:0; left:0; width:100%; height:100vh;
            background:var(--bg-secondary); overflow:hidden; padding:0;
        }
        #viewer-page.active { display:block !important; }

        .viewer-controls-background {
            position:fixed; top:0; left:0; right:0;
            background:var(--bg-secondary); padding:15px; z-index:100;
        }
        .viewer-controls-card {
            background:var(--card-bg); padding:15px 20px; border-radius:8px;
            box-shadow:0 2px 8px var(--shadow); border:1px solid var(--border-color);
            display:flex; justify-content:space-between; align-items:center; gap:20px;
        }
        .viewer-info {
            display:flex; flex-direction:column; align-items:center; gap:8px;
            flex:1; max-width:calc(100% - 300px); overflow:hidden;
        }
        .viewer-filename {
            color:#fff; font-size:16px; font-weight:600; text-align:center;
            word-wrap:break-word; overflow-wrap:break-word; line-height:1.3;
        }

        .drag-thumbnail-pinned {
            position:fixed; top:140px; right:15px; width:60px; height:60px;
            object-fit:contain; border:3px solid var(--accent); border-radius:8px;
            cursor:grab; z-index:300; background:rgba(0,0,0,.9);
            box-shadow:0 4px 12px rgba(0,0,0,.6); transition:transform .2s, box-shadow .2s;
            pointer-events:auto;
        }
        .drag-thumbnail-pinned:hover { transform:scale(1.1); box-shadow:0 6px 20px rgba(0,0,0,.8); border-color:var(--accent-hover); }
        .drag-thumbnail-pinned:active { cursor:grabbing; transform:scale(.95); }

        .rotation-controls { display:flex; gap:5px; }
        .btn-rotate {
            padding:12px 18px; font-size:16px; background:var(--accent);
            color:#fff; border:none; border-radius:4px; cursor:pointer; font-weight:600;
        }
        .btn-rotate:hover { background:var(--accent-hover); }

        .btn-crop {
            padding:12px 18px; font-size:16px; background:var(--crop-accent);
            color:#000; border:none; border-radius:4px; cursor:pointer; font-weight:600;
        }
        .btn-crop:hover { background:var(--crop-accent-hover); }
        .btn-crop.active { background:#ff9800; box-shadow:0 0 10px rgba(255,152,0,.5); }

        /* ‚îÄ‚îÄ‚îÄ viewer canvas area ‚îÄ‚îÄ‚îÄ */
        .viewer-canvas-container {
            position:fixed; top:100px; left:0; right:0; bottom:0;
            overflow:hidden; cursor:grab; background:var(--bg-primary);
        }
        .viewer-canvas-container.dragging { cursor:grabbing; }
        .viewer-canvas-container.cropping { cursor:crosshair; }

        .viewer-canvas { position:relative; width:100%; height:100%; }
        .viewer-canvas img {
            display:block; position:absolute; transform-origin:0 0;
            max-width:none; user-select:none; -webkit-user-drag:none;
        }

        /* ‚îÄ‚îÄ‚îÄ crop SVG overlay (dark mask with cutout) ‚îÄ‚îÄ‚îÄ */
        #cropSvg {
            position:absolute; top:0; left:0; width:100%; height:100%;
            pointer-events:none; z-index:50; display:none;
        }
        #cropSvg.active { display:block; }

        /* ‚îÄ‚îÄ‚îÄ crop selection border + handles ‚îÄ‚îÄ‚îÄ */
        #cropBox {
            position:absolute; border:2px solid var(--crop-accent);
            cursor:move; pointer-events:auto; z-index:60;
            display:none; box-sizing:border-box;
        }
        #cropBox.active { display:block; }

        .crop-handle {
            position:absolute; width:12px; height:12px;
            background:var(--crop-accent); border:2px solid #000;
            pointer-events:auto;
        }
        .crop-handle.nw { top:-6px; left:-6px; cursor:nw-resize; }
        .crop-handle.ne { top:-6px; right:-6px; cursor:ne-resize; }
        .crop-handle.sw { bottom:-6px; left:-6px; cursor:sw-resize; }
        .crop-handle.se { bottom:-6px; right:-6px; cursor:se-resize; }
        .crop-handle.n  { top:-6px; left:50%; margin-left:-6px; cursor:n-resize; }
        .crop-handle.s  { bottom:-6px; left:50%; margin-left:-6px; cursor:s-resize; }
        .crop-handle.w  { top:50%; left:-6px; margin-top:-6px; cursor:w-resize; }
        .crop-handle.e  { top:50%; right:-6px; margin-top:-6px; cursor:e-resize; }

        /* ‚îÄ‚îÄ‚îÄ crop bottom bar ‚îÄ‚îÄ‚îÄ */
        .crop-controls {
            position:fixed; bottom:30px; left:50%; transform:translateX(-50%);
            background:var(--card-bg); padding:15px 25px; border-radius:8px;
            box-shadow:0 4px 12px var(--shadow); border:1px solid var(--border-color);
            display:none; gap:10px; z-index:200;
        }
        .crop-controls.active { display:flex; }
        .btn-crop-apply  { background:var(--crop-accent); color:#000; }
        .btn-crop-apply:hover  { background:var(--crop-accent-hover); }
        .btn-crop-cancel { background:#dc3545; }
        .btn-crop-cancel:hover { background:#c82333; }
        .btn-crop-reset  { background:#17a2b8; }
        .btn-crop-reset:hover  { background:#138496; }

        /* ‚îÄ‚îÄ‚îÄ responsive grid ‚îÄ‚îÄ‚îÄ */
        @media (max-width:1200px) { .image-grid { grid-template-columns:repeat(3,1fr); } }
        @media (max-width:768px)  { .image-grid { grid-template-columns:repeat(2,1fr); } }
        @media (max-width:480px)  { .image-grid { grid-template-columns:1fr; } }
    </style>
</head>
<body>

<!-- Page 1: Upload -->
<div id="upload-page" class="page active">
    <div class="upload-container">
        <h1>Image Rotator &amp; Viewer</h1>
        <p>Select multiple images to process</p>
        <div class="file-input-wrapper">
            <input type="file" id="fileInput" multiple accept="image/*">
            <label for="fileInput" class="file-input-label">
                <div style="font-size:48px;margin-bottom:10px">üìÅ</div>
                <div>Click to select images or drag and drop</div>
            </label>
        </div>
        <div class="file-count" id="fileCount">No files selected</div>
        <button class="btn btn-primary" id="processBtn" disabled>Process Images</button>
    </div>
</div>

<!-- Page 2: Grid -->
<div id="grid-page" class="page">
    <div class="grid-header">
        <div>
            <h2>Uploaded Images</h2>
            <p id="imageCount"></p>
        </div>
        <div class="upload-more-container">
            <input type="file" id="uploadMoreInput" accept="image/*" multiple style="display:none">
            <div id="uploadMoreDropZone" class="upload-more-unified">
                <div class="upload-more-title">Upload More</div>
                <div class="upload-more-subtitle">Click to select or drag &amp; drop</div>
            </div>
        </div>
    </div>
    <div id="loadingMessage" class="loading">Processing images...</div>
    <div class="image-grid" id="imageGrid"></div>
    <div class="done-section">
        <h3>Completed Files:</h3>
        <div id="doneList" class="done-list"></div>
    </div>
</div>

<!-- Page 3: Viewer -->
<div id="viewer-page" class="page">
    <div class="viewer-controls-background">
        <div class="viewer-controls-card">
            <button class="btn btn-secondary btn-small" id="backToGridBtn">Return</button>
            <div class="viewer-info">
                <span id="viewerFileName" class="viewer-filename"></span>
                <div class="rotation-controls">
                    <button class="btn-rotate" id="rotateLeftBtn">‚ü≤ Rotate Left</button>
                    <button class="btn-rotate" id="rotateRightBtn">‚ü≥ Rotate Right</button>
                    <button class="btn-crop" id="cropBtn">‚úÇÔ∏è Crop</button>
                </div>
            </div>
            <button class="btn btn-small" id="doneBtn">‚úì Done</button>
        </div>
    </div>

    <div class="viewer-canvas-container" id="canvasContainer">
        <div class="viewer-canvas" id="viewerCanvas">
            <img id="viewerImage" alt="Viewing image">
        </div>

        <!--
          SVG mask overlay.
          maskBg  = black (hides everything)
          maskCut = white rect (punches a hole ‚Üí image shows at full brightness there)
          darkOverlay rect uses this mask so it's opaque everywhere EXCEPT the cutout.
        -->
        <svg id="cropSvg">
            <defs>
                <mask id="cropMask">
                    <rect id="maskBg"  x="0" y="0" width="9999" height="9999" fill="white"/>
                    <rect id="maskCut" x="0" y="0" width="0"    height="0"    fill="black"/>
                </mask>
            </defs>
            <rect id="darkOverlay" x="0" y="0" width="9999" height="9999"
                  fill="rgba(0,0,0,0.6)" mask="url(#cropMask)"/>
        </svg>

        <!-- crop selection border + handles (positioned in screen px) -->
        <div id="cropBox">
            <div class="crop-handle nw" data-handle="nw"></div>
            <div class="crop-handle n"  data-handle="n"></div>
            <div class="crop-handle ne" data-handle="ne"></div>
            <div class="crop-handle w"  data-handle="w"></div>
            <div class="crop-handle e"  data-handle="e"></div>
            <div class="crop-handle sw" data-handle="sw"></div>
            <div class="crop-handle s"  data-handle="s"></div>
            <div class="crop-handle se" data-handle="se"></div>
        </div>

        <img id="dragThumbnail" class="drag-thumbnail-pinned" alt="Drag to upload" draggable="true">
    </div>

    <div class="crop-controls" id="cropControls">
        <button class="btn btn-small btn-crop-reset"  id="resetCropBtn">‚Ü∫ Reset to Original</button>
        <button class="btn btn-small btn-crop-cancel" id="cancelCropBtn">‚úï Cancel</button>
        <button class="btn btn-small btn-crop-apply"  id="applyCropBtn">‚úì Apply Crop</button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    let uploadedFiles       = [];
    let processedImages     = [];   // { dataUrl, originalDataUrl, fileName }
    let doneFiles           = [];
    let currentViewingIndex = -1;

    // pan / zoom
    let scale = 1, translateX = 0, translateY = 0;
    let isDragging = false, dragStartX = 0, dragStartY = 0, dragTranslateX = 0, dragTranslateY = 0;
    let dragOffScreenMode = false;

    // crop ‚Äì all in IMAGE pixels
    let isCropping      = false;
    let cropX = 0, cropY = 0, cropW = 0, cropH = 0;
    let isDrawing       = false;
    let drawOriginX     = 0, drawOriginY = 0;
    let isDraggingCrop  = false;
    let isResizingCrop  = false;
    let resizeHandle    = null;
    let cropDragStartX  = 0, cropDragStartY = 0;
    let cropSnapX = 0, cropSnapY = 0, cropSnapW = 0, cropSnapH = 0;
    let preCropDataUrl = null;   // snapshot of dataUrl when crop mode is entered
    let currentRotation = 0;     // cumulative rotation in degrees (mod 360)

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ DOM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    const uploadPage          = document.getElementById('upload-page');
    const gridPage            = document.getElementById('grid-page');
    const viewerPage          = document.getElementById('viewer-page');
    const fileInput           = document.getElementById('fileInput');
    const fileCountEl         = document.getElementById('fileCount');
    const processBtn          = document.getElementById('processBtn');
    const imageGrid           = document.getElementById('imageGrid');
    const loadingMessage      = document.getElementById('loadingMessage');
    const viewerImage         = document.getElementById('viewerImage');
    const viewerCanvas        = document.getElementById('viewerCanvas');
    const canvasContainer     = document.getElementById('canvasContainer');
    const backToGridBtn       = document.getElementById('backToGridBtn');
    const doneBtn             = document.getElementById('doneBtn');
    const doneList            = document.getElementById('doneList');
    const uploadMoreInput     = document.getElementById('uploadMoreInput');
    const uploadMoreDropZone  = document.getElementById('uploadMoreDropZone');
    const dragThumbnail       = document.getElementById('dragThumbnail');
    const viewerFileNameEl    = document.getElementById('viewerFileName');
    const rotateLeftBtn       = document.getElementById('rotateLeftBtn');
    const rotateRightBtn      = document.getElementById('rotateRightBtn');
    const cropBtnEl           = document.getElementById('cropBtn');
    const cropControls        = document.getElementById('cropControls');
    const applyCropBtn        = document.getElementById('applyCropBtn');
    const cancelCropBtn       = document.getElementById('cancelCropBtn');
    const resetCropBtn        = document.getElementById('resetCropBtn');
    const cropBoxEl           = document.getElementById('cropBox');
    const cropSvg             = document.getElementById('cropSvg');
    const maskCut             = document.getElementById('maskCut');

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ upload page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    fileInput.addEventListener('change', function (e) {
        uploadedFiles = Array.from(e.target.files);
        updateFileCount();
    });
    function updateFileCount() {
        if (!uploadedFiles.length) { fileCountEl.textContent='No files selected'; processBtn.disabled=true; }
        else { fileCountEl.textContent = uploadedFiles.length+' file'+(uploadedFiles.length>1?'s':'')+' selected'; processBtn.disabled=false; }
    }
    processBtn.addEventListener('click', async function () { showPage('grid'); await processImages(); });

    const uploadContainer = document.querySelector('.upload-container');
    uploadContainer.addEventListener('dragover',  e=>{ e.preventDefault(); e.stopPropagation(); });
    uploadContainer.addEventListener('drop', function(e){
        e.preventDefault(); e.stopPropagation();
        const files = Array.from(e.dataTransfer.files).filter(f=>f.type.startsWith('image/'));
        if(files.length){ uploadedFiles=files; updateFileCount(); }
    });

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ grid ‚Äì upload more ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    uploadMoreDropZone.addEventListener('click', ()=> uploadMoreInput.click());
    uploadMoreInput.addEventListener('change', async function(e){ const f=Array.from(e.target.files); if(f.length) await addMoreFiles(f); });
    uploadMoreDropZone.addEventListener('dragover',  e=>{ e.preventDefault(); uploadMoreDropZone.classList.add('drag-over'); });
    uploadMoreDropZone.addEventListener('dragleave', e=>{ e.preventDefault(); uploadMoreDropZone.classList.remove('drag-over'); });
    uploadMoreDropZone.addEventListener('drop', async function(e){
        e.preventDefault(); uploadMoreDropZone.classList.remove('drag-over');
        const f=Array.from(e.dataTransfer.files).filter(f=>f.type.startsWith('image/'));
        if(f.length) await addMoreFiles(f);
    });

    async function addMoreFiles(newFiles){
        loadingMessage.style.display='block';
        for(const file of newFiles){
            const d = await fileToDataUrl(file);
            uploadedFiles.push(file);
            processedImages.push({ dataUrl:d, originalDataUrl:d, fileName:file.name });
        }
        displayGrid();
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ processing ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    async function processImages(){
        loadingMessage.style.display='block';
        imageGrid.innerHTML='';
        processedImages=[];
        for(const file of uploadedFiles){
            const d = await fileToDataUrl(file);
            processedImages.push({ dataUrl:d, originalDataUrl:d, fileName:file.name });
        }
        displayGrid();
    }
    function fileToDataUrl(file){
        return new Promise(resolve=>{
            const r=new FileReader();
            r.onload=e=>resolve(e.target.result);
            r.readAsDataURL(file);
        });
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ grid display ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    function displayGrid(){
        loadingMessage.style.display='none';
        imageGrid.innerHTML='';
        document.getElementById('imageCount').textContent =
            processedImages.length+' image'+(processedImages.length!==1?'s':'')+' uploaded';

        processedImages.forEach((img,index)=>{
            const item   = document.createElement('div');  item.className='grid-item';
            const imgEl  = document.createElement('img');  imgEl.src=img.dataUrl; imgEl.className='grid-item-image';
            const nameCon= document.createElement('div');  nameCon.className='grid-item-name-container';
            const nameEl = document.createElement('div');  nameEl.className='grid-item-name';
            nameEl.textContent = img.fileName.replace(/\.[^/.]+$/,'');

            const delBtn = document.createElement('button');
            delBtn.className='delete-btn';
            delBtn.innerHTML='<svg viewBox="0 0 24 24"><path d="M19 4h-3.5l-1-1h-5l-1 1H5v2h14M6 19a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7H6v12z"/></svg>';
            delBtn.title='Delete';
            delBtn.addEventListener('click', e=>{ e.stopPropagation(); deleteImage(index); });

            nameCon.appendChild(nameEl);
            nameCon.appendChild(delBtn);
            item.appendChild(imgEl);
            item.appendChild(nameCon);
            item.addEventListener('click', ()=> openViewer(index));
            imageGrid.appendChild(item);
        });
        updateDoneList();
    }
    function updateDoneList(){
        doneList.innerHTML = doneFiles.length
            ? doneFiles.map(n=>'<div class="done-item">'+n+'</div>').join('')
            : '<em style="color:#6c757d">No completed files yet</em>';
    }
    function deleteImage(index){
        if(confirm('Delete "'+processedImages[index].fileName+'"?')){
            processedImages.splice(index,1);
            uploadedFiles = Array.from(uploadedFiles).filter((_,i)=>i!==index);
            displayGrid();
        }
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ viewer open ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    function openViewer(index){
        currentViewingIndex=index;
        currentRotation=0;   // fresh image, no rotation yet
        const img=processedImages[index];
        viewerImage.src   = img.dataUrl;
        dragThumbnail.src = img.dataUrl;
        viewerFileNameEl.textContent = img.fileName.replace(/\.[^/.]+$/,'');
        scale=1; translateX=0; translateY=0;
        exitCropMode();
        viewerImage.onload = ()=> centerImage();
        showPage('viewer');
    }

    function centerImage(){
        const cw=canvasContainer.clientWidth, ch=canvasContainer.clientHeight;
        const iw=viewerImage.naturalWidth,    ih=viewerImage.naturalHeight;
        if(!iw||!ih) return;
        scale      = Math.min(cw/iw, ch/ih, 1)*0.9;
        translateX = (cw - iw*scale)/2;
        translateY = (ch - ih*scale)/2;
        updateViewerTransform();
    }
    function updateViewerTransform(){
        viewerImage.style.transform = 'translate('+translateX+'px,'+translateY+'px) scale('+scale+')';
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ zoom ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    canvasContainer.addEventListener('wheel', function(e){
        if(isCropping) return;
        e.preventDefault();
        const rect=canvasContainer.getBoundingClientRect();
        const mx=e.clientX-rect.left, my=e.clientY-rect.top;
        const imgX=(mx-translateX)/scale, imgY=(my-translateY)/scale;
        const ns = scale * (e.deltaY>0 ? 0.9 : 1.1);
        if(ns<0.1||ns>10) return;
        scale=ns;
        translateX = mx - imgX*scale;
        translateY = my - imgY*scale;
        updateViewerTransform();
    });

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ drag thumbnail (drag-to-upload) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    dragThumbnail.addEventListener('dragstart', function(e){
        if(currentViewingIndex<0) return;
        const img=processedImages[currentViewingIndex];
        e.dataTransfer.effectAllowed='copy';
        e.dataTransfer.setData('DownloadURL','image/jpeg:'+img.fileName+':'+img.dataUrl);
    });

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ mousedown ‚Äì routes to crop / pan / shift-drag ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    canvasContainer.addEventListener('mousedown', function(e){
        if(e.target===dragThumbnail) return;

        /* ‚îÄ‚îÄ crop mode intercept ‚îÄ‚îÄ */
        if(isCropping){
            if(e.target.classList.contains('crop-handle')) return;  // handle has its own listener
            if(e.target===cropBoxEl){ startDragCrop(e); return; }   // drag the box
            startDrawCrop(e);                                        // draw a new rect
            return;
        }

        /* ‚îÄ‚îÄ normal modes ‚îÄ‚îÄ */
        if(e.button!==0) return;
        if(e.shiftKey){
            dragOffScreenMode=true;
            viewerCanvas.setAttribute('draggable','true');
            viewerImage.setAttribute('draggable','true');
        } else {
            dragOffScreenMode=false;
            viewerCanvas.setAttribute('draggable','false');
            viewerImage.setAttribute('draggable','false');
            isDragging=true;
            dragStartX=e.clientX; dragStartY=e.clientY;
            dragTranslateX=translateX; dragTranslateY=translateY;
            canvasContainer.classList.add('dragging');
            e.preventDefault();
        }
    });

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ pan mousemove / mouseup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    document.addEventListener('mousemove', function(e){
        if(isDragging && !dragOffScreenMode && !isCropping){
            translateX = dragTranslateX + (e.clientX - dragStartX);
            translateY = dragTranslateY + (e.clientY - dragStartY);
            updateViewerTransform();
        }
    });
    document.addEventListener('mouseup', function(e){
        if(isDragging){ isDragging=false; canvasContainer.classList.remove('dragging'); }
        if(dragOffScreenMode && !e.shiftKey){
            viewerCanvas.setAttribute('draggable','false');
            viewerImage.setAttribute('draggable','false');
            canvasContainer.style.cursor='';
            dragOffScreenMode=false;
        }
    });

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ shift-drag file export ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    function setupDragHandler(el){
        el.addEventListener('dragstart', function(e){
            if(!dragOffScreenMode){ e.preventDefault(); return; }
            if(currentViewingIndex<0){ e.preventDefault(); return; }
            const img=processedImages[currentViewingIndex];
            if(!img){ e.preventDefault(); return; }
            e.dataTransfer.effectAllowed='copy';
            e.dataTransfer.setData('DownloadURL','image/jpeg:'+img.fileName+':'+img.dataUrl);
        });
        el.addEventListener('dragend', function(){
            viewerCanvas.setAttribute('draggable','false');
            viewerImage.setAttribute('draggable','false');
            canvasContainer.style.cursor='';
            dragOffScreenMode=false;
        });
    }
    setupDragHandler(viewerCanvas);
    setupDragHandler(viewerImage);

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ rotation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    // Returns a promise that resolves to a dataUrl of srcUrl rotated by degrees.
    // degrees can be 90, 180, 270, -90, etc.  0 ‚Üí resolves with srcUrl unchanged.
    function applyRotation(srcUrl, degrees){
        degrees = ((degrees % 360) + 360) % 360;   // normalise to 0-359
        if(degrees === 0) return Promise.resolve(srcUrl);
        return new Promise(function(resolve){
            const tmp = new Image();
            tmp.onload = function(){
                const c   = document.createElement('canvas');
                const ctx = c.getContext('2d');
                if(degrees === 90 || degrees === 270){ c.width=tmp.height; c.height=tmp.width; }
                else                                 { c.width=tmp.width;  c.height=tmp.height; }
                ctx.translate(c.width/2, c.height/2);
                ctx.rotate(degrees * Math.PI / 180);
                ctx.drawImage(tmp, -tmp.width/2, -tmp.height/2);
                resolve(c.toDataURL('image/jpeg', 0.95));
            };
            tmp.src = srcUrl;
        });
    }

    rotateLeftBtn.addEventListener('click',  ()=> rotateCurrentImage(-90));
    rotateRightBtn.addEventListener('click', ()=> rotateCurrentImage(90));

    function rotateCurrentImage(degrees){
        if(currentViewingIndex<0) return;
        currentRotation = ((currentRotation + degrees) % 360 + 360) % 360;
        // rotate the current dataUrl by the single step (not the cumulative angle)
        applyRotation(processedImages[currentViewingIndex].dataUrl, degrees).then(function(d){
            processedImages[currentViewingIndex].dataUrl = d;
            // originalDataUrl intentionally NOT touched
            viewerImage.src=d; dragThumbnail.src=d;
            const gi=imageGrid.querySelectorAll('.grid-item-image');
            if(gi[currentViewingIndex]) gi[currentViewingIndex].src=d;
            viewerImage.onload=()=> centerImage();
        });
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ back / done ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    backToGridBtn.addEventListener('click', ()=>{ exitCropMode(); showPage('grid'); });
    doneBtn.addEventListener('click', function(){
        if(currentViewingIndex<0||currentViewingIndex>=processedImages.length) return;
        doneFiles.push(processedImages[currentViewingIndex].fileName);
        processedImages.splice(currentViewingIndex,1);
        uploadedFiles = Array.from(uploadedFiles).filter((_,i)=>i!==currentViewingIndex);
        exitCropMode(); showPage('grid'); displayGrid();
    });

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       CROP SYSTEM
       cropX / cropY / cropW / cropH  are in IMAGE pixels.
       Screen conversion:  sx = imgPx * scale + translateX
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    cropBtnEl.addEventListener('click', function(){
        if(isCropping) exitCropMode();
        else           enterCropMode();
    });

    function enterCropMode(){
        isCropping=true;
        cropBtnEl.classList.add('active');
        canvasContainer.classList.add('cropping');
        cropControls.classList.add('active');

        // snapshot the current working image ‚Äì this is what we crop FROM and reset TO
        preCropDataUrl = processedImages[currentViewingIndex].dataUrl;
        viewerImage.src   = preCropDataUrl;
        dragThumbnail.src = preCropDataUrl;

        // show dark overlay immediately; cutout 0-size until user draws
        cropSvg.classList.add('active');
        maskCut.setAttribute('x',0);
        maskCut.setAttribute('y',0);
        maskCut.setAttribute('width',0);
        maskCut.setAttribute('height',0);
        cropBoxEl.classList.remove('active');

        // re-centre once image is ready (or now if already loaded)
        viewerImage.onload = ()=> centerImage();
        centerImage();   // in case onload already fired / won't fire
    }

    function exitCropMode(){
        isCropping=false; isDrawing=false; isDraggingCrop=false; isResizingCrop=false;
        cropBtnEl.classList.remove('active');
        canvasContainer.classList.remove('cropping');
        cropControls.classList.remove('active');
        cropSvg.classList.remove('active');
        cropBoxEl.classList.remove('active');
    }

    /* ‚îÄ‚îÄ coordinate helpers ‚îÄ‚îÄ */
    function screenToImg(sx,sy){ return { x:(sx-translateX)/scale, y:(sy-translateY)/scale }; }

    function normCrop(){
        let x=cropX, y=cropY, w=cropW, h=cropH;
        if(w<0){ x+=w; w=-w; }
        if(h<0){ y+=h; h=-h; }
        return {x,y,w,h};
    }

    /* ‚îÄ‚îÄ paint the overlay + selection box ‚îÄ‚îÄ */
    function paintCrop(){
        const n=normCrop();
        const sx = n.x*scale + translateX;
        const sy = n.y*scale + translateY;
        const sw = n.w*scale;
        const sh = n.h*scale;

        // SVG cutout
        maskCut.setAttribute('x',      sx);
        maskCut.setAttribute('y',      sy);
        maskCut.setAttribute('width',  sw);
        maskCut.setAttribute('height', sh);

        // border + handles
        cropBoxEl.style.left   = sx+'px';
        cropBoxEl.style.top    = sy+'px';
        cropBoxEl.style.width  = sw+'px';
        cropBoxEl.style.height = sh+'px';
        cropBoxEl.classList.add('active');
    }

    /* ‚îÄ‚îÄ DRAW a new crop rect ‚îÄ‚îÄ */
    function startDrawCrop(e){
        const rect = canvasContainer.getBoundingClientRect();
        const sp   = screenToImg(e.clientX-rect.left, e.clientY-rect.top);
        drawOriginX = sp.x;
        drawOriginY = sp.y;
        cropX=sp.x; cropY=sp.y; cropW=0; cropH=0;
        isDrawing=true;
        e.preventDefault();
        document.addEventListener('mousemove', onDrawMove);
        document.addEventListener('mouseup',   onDrawUp);
    }

    function onDrawMove(e){
        if(!isDrawing) return;
        const rect = canvasContainer.getBoundingClientRect();
        const sp   = screenToImg(e.clientX-rect.left, e.clientY-rect.top);
        cropX = drawOriginX;
        cropY = drawOriginY;
        cropW = sp.x - drawOriginX;
        cropH = sp.y - drawOriginY;
        paintCrop();
    }

    function onDrawUp(e){
        document.removeEventListener('mousemove', onDrawMove);
        document.removeEventListener('mouseup',   onDrawUp);
        isDrawing=false;

        // single-click (tiny rect) ‚Üí spawn a default box at the click point
        const n=normCrop();
        if(n.w<5 || n.h<5){
            const iw=viewerImage.naturalWidth, ih=viewerImage.naturalHeight;
            const defW = Math.min(iw*0.4, 300);
            const defH = Math.min(ih*0.4, 300);
            cropX = Math.max(0, Math.min(drawOriginX - defW/2, iw-defW));
            cropY = Math.max(0, Math.min(drawOriginY - defH/2, ih-defH));
            cropW = defW;
            cropH = defH;
        }
        paintCrop();
    }

    /* ‚îÄ‚îÄ DRAG the box ‚îÄ‚îÄ */
    function startDragCrop(e){
        isDraggingCrop=true;
        cropDragStartX=e.clientX; cropDragStartY=e.clientY;
        // normalise first so dragging doesn't flip
        const n=normCrop();
        cropX=n.x; cropY=n.y; cropW=n.w; cropH=n.h;
        cropSnapX=n.x; cropSnapY=n.y;
        e.stopPropagation(); e.preventDefault();
        document.addEventListener('mousemove', onDragCropMove);
        document.addEventListener('mouseup',   onDragCropUp);
    }
    function onDragCropMove(e){
        if(!isDraggingCrop) return;
        cropX = cropSnapX + (e.clientX-cropDragStartX)/scale;
        cropY = cropSnapY + (e.clientY-cropDragStartY)/scale;
        paintCrop();
    }
    function onDragCropUp(){
        isDraggingCrop=false;
        document.removeEventListener('mousemove', onDragCropMove);
        document.removeEventListener('mouseup',   onDragCropUp);
    }

    /* ‚îÄ‚îÄ RESIZE via handles ‚îÄ‚îÄ */
    cropBoxEl.querySelectorAll('.crop-handle').forEach(function(handle){
        handle.addEventListener('mousedown', function(e){
            e.stopPropagation(); e.preventDefault();
            isResizingCrop=true;
            resizeHandle   = handle.dataset.handle;
            cropDragStartX = e.clientX;
            cropDragStartY = e.clientY;
            // normalise so all deltas are positive-based
            const n=normCrop();
            cropX=n.x; cropY=n.y; cropW=n.w; cropH=n.h;
            cropSnapX=n.x; cropSnapY=n.y; cropSnapW=n.w; cropSnapH=n.h;
            document.addEventListener('mousemove', onResizeMove);
            document.addEventListener('mouseup',   onResizeUp);
        });
    });

    function onResizeMove(e){
        if(!isResizingCrop) return;
        const dx=(e.clientX-cropDragStartX)/scale;
        const dy=(e.clientY-cropDragStartY)/scale;
        switch(resizeHandle){
            case 'nw': cropX=cropSnapX+dx; cropY=cropSnapY+dy; cropW=cropSnapW-dx; cropH=cropSnapH-dy; break;
            case 'n':                      cropY=cropSnapY+dy;                     cropH=cropSnapH-dy; break;
            case 'ne':                     cropY=cropSnapY+dy; cropW=cropSnapW+dx; cropH=cropSnapH-dy; break;
            case 'w':  cropX=cropSnapX+dx;                     cropW=cropSnapW-dx;                    break;
            case 'e':                                          cropW=cropSnapW+dx;                    break;
            case 'sw': cropX=cropSnapX+dx;                     cropW=cropSnapW-dx; cropH=cropSnapH+dy; break;
            case 's':                                                              cropH=cropSnapH+dy; break;
            case 'se':                                         cropW=cropSnapW+dx; cropH=cropSnapH+dy; break;
        }
        paintCrop();
    }
    function onResizeUp(){
        isResizingCrop=false; resizeHandle=null;
        document.removeEventListener('mousemove', onResizeMove);
        document.removeEventListener('mouseup',   onResizeUp);
    }

    /* ‚îÄ‚îÄ Apply crop ‚îÄ‚îÄ */
    applyCropBtn.addEventListener('click', function(){
        if(currentViewingIndex<0) return;
        const n   = normCrop();
        const src = preCropDataUrl;   // crop from the snapshot taken when crop mode opened

        const tmp=new Image();
        tmp.onload=function(){
            const c=document.createElement('canvas'), ctx=c.getContext('2d');
            c.width=n.w; c.height=n.h;
            ctx.drawImage(tmp, n.x, n.y, n.w, n.h, 0, 0, n.w, n.h);
            const d=c.toDataURL('image/jpeg',0.95);

            processedImages[currentViewingIndex].dataUrl = d;
            // originalDataUrl untouched ‚Äì Reset to Original still reaches upload-time image

            viewerImage.src=d; dragThumbnail.src=d;
            const gi=imageGrid.querySelectorAll('.grid-item-image');
            if(gi[currentViewingIndex]) gi[currentViewingIndex].src=d;
            viewerImage.onload=()=>{ centerImage(); exitCropMode(); };
        };
        tmp.src=src;
    });

    /* ‚îÄ‚îÄ Cancel crop (go back to what was shown before) ‚îÄ‚îÄ */
    cancelCropBtn.addEventListener('click', function(){
        const d = processedImages[currentViewingIndex].dataUrl;
        viewerImage.src=d; dragThumbnail.src=d;
        viewerImage.onload=()=> centerImage();
        exitCropMode();
    });

    /* ‚îÄ‚îÄ Reset to original (restore upload-time pixels, keep current orientation) ‚îÄ‚îÄ */
    resetCropBtn.addEventListener('click', function(){
        if(currentViewingIndex<0) return;
        const orig = processedImages[currentViewingIndex].originalDataUrl;

        // bake the current rotation onto the original so orientation is preserved
        applyRotation(orig, currentRotation).then(function(rotated){
            // write it back as the working copy
            processedImages[currentViewingIndex].dataUrl = rotated;
            preCropDataUrl = rotated;

            // clear crop selection immediately
            maskCut.setAttribute('x',0); maskCut.setAttribute('y',0);
            maskCut.setAttribute('width',0); maskCut.setAttribute('height',0);
            cropBoxEl.classList.remove('active');

            // update everything visible
            viewerImage.src   = rotated;
            dragThumbnail.src = rotated;
            const gi=imageGrid.querySelectorAll('.grid-item-image');
            if(gi[currentViewingIndex]) gi[currentViewingIndex].src=rotated;

            viewerImage.onload = ()=> centerImage();
            centerImage();
        });
    });

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ page switcher ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    function showPage(name){
        document.querySelectorAll('.page').forEach(p=> p.classList.remove('active'));
        if(name==='upload') uploadPage.classList.add('active');
        else if(name==='grid')   gridPage.classList.add('active');
        else if(name==='viewer') viewerPage.classList.add('active');
    }

});
</script>
</body>
</html>
